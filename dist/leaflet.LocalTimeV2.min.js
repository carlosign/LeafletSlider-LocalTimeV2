L.Control.SliderControl=L.Control.extend({options:{position:"topright",layer:null,timeAttribute:"time",isEpoch:!1,startTimeIdx:0,timeStrLength:19,maxValue:-1,minValue:0,showAllOnStart:!1,markers:null,range:!1,follow:0,sameDate:!1,alwaysShowDate:!1,rezoom:null,orderMarkers:!0,orderDesc:!1,popupOptions:{},popupContent:"",showAllPopups:!0,showPopups:!0,onlyDateString:!0},initialize:function(e){L.Util.setOptions(this,e),this._layer=this.options.layer,L.extend(this,L.Mixin.Events)},onAdd:function(e){this.options.map=e,this.container=L.DomUtil.create("div","",this._container),this.sliderBoxContainer=L.DomUtil.create("div","slider",this.container);var t=L.DomUtil.create("div","",this.sliderBoxContainer);t.id="leaflet-slider",t.style.width="200px",L.DomUtil.create("div","ui-slider-handle",t),this.timestampContainer=L.DomUtil.create("div","slider",this.container),this.timestampContainer.id="slider-timestamp",this.timestampContainer.style.cssText="width:200px; margin-top:3px; background-color:#FFFFFF; text-align:center; border-radius:5px;display:none;",L.DomEvent.disableClickPropagation(this.sliderBoxContainer),this._map.on("mouseup",this.clearTimestamp,this);var r=this.options;if(this.options.markers=[],this._layer){var i=0,o=[];this._layer.eachLayer((function(e){o.push(e)})),r.orderMarkers&&(o=o.sort((function(e,t){var i=null,o=null;if(e.feature&&e.feature.properties&&e.feature.properties[r.timeAttribute]?i=e.feature.properties[r.timeAttribute]:e.options[r.timeAttribute]&&(i=e.options[r.timeAttribute]),t.feature&&t.feature.properties&&t.feature.properties[r.timeAttribute]?o=t.feature.properties[r.timeAttribute]:t.options[r.timeAttribute]&&(o=t.options[r.timeAttribute]),i&&o){if(i<o)return-1;if(i>o)return 1}return 0})),r.orderDesc&&(o=o.reverse()));var a=this;o.forEach((function(e){e instanceof L.LayerGroup?e.getLayers().forEach((function(e){e=a._setPopupProperty(e)})):e=a._setPopupProperty(e),r.markers[i]=e,++i})),r.maxValue=i-1,this.options=r}else console.log("Error: You have to specify a layer via new SliderControl({layer: your_layer});");return this.container},onRemove:function(e){for(i=this.options.minValue;i<=this.options.maxValue;i++)e.removeLayer(this.options.markers[i]);this.container.remove(),e.off("mouseup",this.clearTimestamp,this)},startSlider:function(){var e=this.options,t=this.extractTimestamp,r=e.minValue,o=e.minValue;e.showAllOnStart&&(r=e.maxValue,e.range?e.values=[e.minValue,e.maxValue]:e.value=e.maxValue);var a=this.timestampContainer,s=this;if($(this.sliderBoxContainer).slider({range:e.range,value:e.value,values:e.values,min:e.minValue,max:e.maxValue,sameDate:e.sameDate,step:1,slide:function(r,i){var o=e.map,s=L.featureGroup();if(e.markers[i.value])if(void 0!==e.markers[i.value].feature)e.markers[i.value].feature.properties[e.timeAttribute]?e.markers[i.value]&&(a.style.display="block",$(a).html(t(e.markers[i.value].feature.properties[e.timeAttribute],e))):console.error("Time property "+e.timeAttribute+" not found in data");else if(e.markers[i.value].options[e.timeAttribute]){if(e.markers[i.value]){a.style.display="block";var n=t(e.markers[i.values[0]].options[e.timeAttribute],e),p=t(e.markers[i.values[1]].options[e.timeAttribute],e);console.log(n+"-"+p),$(a).html(n+" - "+p)}}else console.error("Time property "+e.timeAttribute+" not found in data");e.rezoom&&o.fitBounds(s.getBounds(),{maxZoom:e.rezoom})},change:function(t,r){var i=e.map,o=L.featureGroup();if(e.markers[r.value]){var a,n=[];for(a=e.minValue;a<=e.maxValue;a++)e.markers[a]&&i.removeLayer(e.markers[a]);if(e.range)for(a=r.values[0];a<=r.values[1];a++)e.markers[a]&&(n.push(e.markers[a]),i.addLayer(e.markers[a]),o.addLayer(e.markers[a]));else if(e.follow>0)for(a=r.value-e.follow+1;a<=r.value;a++)e.markers[a]&&(n.push(e.markers[a]),i.addLayer(e.markers[a]),o.addLayer(e.markers[a]));else if(e.sameDate){var p;for(p=void 0!==e.markers[r.value].feature?e.markers[r.value].feature.properties.time:e.markers[r.value].options.time,a=e.minValue;a<=e.maxValue;a++)e.markers[a].options.time==p&&(n.push(e.markers[a]),i.addLayer(e.markers[a]))}else for(a=e.minValue;a<=r.value;a++)e.markers[a]&&(n.push(e.markers[a]),i.addLayer(e.markers[a]),o.addLayer(e.markers[a]));e.showPopups&&s._openPopups(n),s.fire("rangechanged",{markers:n})}}}),e.alwaysShowDate)if(a.style.display="block",void 0!==e.markers[r].feature)e.markers[r].feature.properties[e.timeAttribute]?e.markers[r]&&(a.style.display="block",$(a).html(t(e.markers[r].feature.properties[e.timeAttribute],e))):console.error("Time property "+e.timeAttribute+" not found in data");else if(e.markers[r].options[e.timeAttribute]){if(e.markers[r]){a.style.display="block";var n=t(e.markers[r].options[e.timeAttribute],e),p=t(e.markers[o].options[e.timeAttribute],e);console.log(p+"-"+n),$(a).html(p+" - "+n)}}else console.error("Time property "+e.timeAttribute+" not found in data");var l=[];for(i=e.minValue;i<=r;i++)l.push(e.markers[i]),e.map.addLayer(e.markers[i]);e.showPopups&&this._openPopups(l),this.fire("rangechanged",{markers:l})},clearTimestamp:function(){this.options.alwaysShowDate||(this.timestampContainer.innerHTML="",this.timestampContainer.style.display="none")},extractTimestamp:function(e,t){return t.isEpoch&&(e=new Date(parseInt(e)).toString()),(e=t.onlyDateString?new Date(e).toLocaleString([],{year:"numeric",month:"numeric",day:"numeric"}):new Date(e).toLocaleString()).substr(t.startTimeIdx,t.startTimeIdx+t.timeStrLength)},setPosition:function(e){var t=this._map;return t&&t.removeControl(this),this.options.position=e,t&&t.addControl(this),this.startSlider(),this},_setPopupProperty:function(e){return e._popup&&(e._orgpopup=e._popup),e},_openPopups:function(e){var t=this.options,r=this;e.forEach((function(e){if(e instanceof L.LayerGroup)r._openPopups(e.getLayers());else if(e._orgpopup)e._popup=e._orgpopup,t.showAllPopups&&(e._popup.options.autoClose=!1),e.openPopup();else if(t.popupContent){var i=t.popupOptions;t.showAllPopups&&(i.autoClose=!1),e.bindPopup(t.popupContent,i).openPopup()}}))}}),L.control.sliderControl=function(e){return new L.Control.SliderControl(e)};
